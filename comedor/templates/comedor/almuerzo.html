{% extends "admin/base_site.html" %}

{% block content %}
<div class="module" style="padding:1rem;max-width:900px;">
  <h1>Registro de almuerzo</h1>
  <p>Escanee el QR o escriba la identificación y presione Enter.</p>

  {% if not curso_lectivo %}
    <p style="color:#b91c1c;font-weight:700;">No existe curso lectivo activo.</p>
  {% endif %}

  {% if es_superusuario %}
    <div style="margin-bottom:1rem;">
      <label for="institucion_id">Institución</label>
      <select id="institucion_id" style="width:100%;max-width:420px;">
        <option value="">Seleccione</option>
        {% for item in instituciones %}
          <option value="{{ item.id }}" {% if institucion and item.id == institucion.id %}selected{% endif %}>{{ item.nombre }}</option>
        {% endfor %}
      </select>
    </div>
  {% endif %}

  <form id="form_almuerzo">
    {% csrf_token %}
    <input
      type="text"
      id="identificacion"
      name="identificacion"
      placeholder="Identificación del estudiante"
      autocomplete="off"
      style="width:100%;font-size:2rem;padding:1rem;border:2px solid #9ca3af;border-radius:12px;"
      {% if not curso_lectivo %}disabled{% endif %}
    >
  </form>

  <div id="resultado" style="margin-top:1rem;padding:1rem;border-radius:10px;display:none;font-size:1.35rem;font-weight:700;"></div>
</div>

<script>
  const form = document.getElementById("form_almuerzo");
  const input = document.getElementById("identificacion");
  const resultado = document.getElementById("resultado");
  const institucionSelect = document.getElementById("institucion_id");

  function mostrarResultado(tipo, mensaje) {
    resultado.style.display = "block";
    resultado.textContent = mensaje;
    if (tipo === "ok") {
      resultado.style.background = "#dcfce7";
      resultado.style.color = "#166534";
    } else if (tipo === "duplicado") {
      resultado.style.background = "#fef3c7";
      resultado.style.color = "#92400e";
    } else {
      resultado.style.background = "#fee2e2";
      resultado.style.color = "#991b1b";
    }
  }

  form.addEventListener("submit", async function (event) {
    event.preventDefault();
    const identificacion = input.value.trim();
    if (!identificacion) return;

    const data = new FormData();
    data.append("identificacion", identificacion);
    {% if es_superusuario %}
      data.append("institucion", institucionSelect ? institucionSelect.value : "");
    {% endif %}

    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
    const response = await fetch("", {
      method: "POST",
      headers: { "X-CSRFToken": csrfToken },
      body: data
    });

    const payload = await response.json();
    if (!response.ok || !payload.ok) {
      mostrarResultado("error", payload.message || "Error al registrar almuerzo.");
    } else {
      mostrarResultado(payload.status, payload.message);
    }
    input.value = "";
    input.focus();
  });

  input.focus();
</script>
{% endblock %}

