{% extends "admin/base_site.html" %}
{% load i18n %}

{% block title %}Períodos por Curso Lectivo{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
:root{--primary:#1a6eb5;--primary-dark:#145591;--success:#198754;--border:#dee2e6;--surface:#f8f9fc;--muted:#6c757d;}
.page-wrap{max-width:900px;margin:28px auto;padding:0 16px;font-family:"Segoe UI",system-ui,sans-serif;}
.page-title{font-size:1.65rem;font-weight:700;color:var(--primary-dark);margin-bottom:4px;}
.page-sub{color:var(--muted);margin-bottom:28px;font-size:.95rem;}
.card{background:#fff;border:1px solid var(--border);border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.06);margin-bottom:24px;}
.card-header{background:var(--surface);border-bottom:1px solid var(--border);padding:14px 20px;border-radius:10px 10px 0 0;display:flex;align-items:center;gap:10px;}
.card-header h2{margin:0;font-size:1rem;font-weight:600;color:var(--primary-dark);}
.card-body{padding:20px;}
.filter-bar{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end;}
.fg{display:flex;flex-direction:column;min-width:180px;}
.fg label{font-size:.78rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-bottom:5px;}
.form-control{width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-size:.93rem;box-sizing:border-box;}
.form-control:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(26,110,181,.15);}
.btn{display:inline-flex;align-items:center;gap:6px;padding:9px 18px;font-size:.9rem;font-weight:600;border-radius:6px;border:none;cursor:pointer;transition:filter .15s;}
.btn:hover{filter:brightness(1.08);}
.btn-success{background:var(--success);color:#fff;}
.alert{padding:12px 16px;border-radius:8px;margin-bottom:18px;font-size:.92rem;}
.alert-danger{background:#fef2f2;border:1px solid #fecaca;color:#991b1b;}
.alert-success{background:#f0fdf4;border:1px solid #bbf7d0;color:#166534;}
.periodo-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:14px;display:grid;grid-template-columns:auto 1fr 1fr 1fr auto;gap:12px;align-items:center;}
.periodo-nombre{font-weight:700;font-size:1rem;color:var(--primary-dark);}
.chk-activo{transform:scale(1.3);cursor:pointer;}
</style>
{% endblock %}

{% block content %}
<div class="page-wrap">
  <div class="page-title"><i class="fas fa-calendar-alt"></i> Períodos por Curso Lectivo</div>
  <p class="page-sub">Configure los períodos activos y sus fechas para cada institución y año lectivo.</p>

  {% if messages %}
    {% for m in messages %}
      <div class="alert alert-{{ m.tags|default:'success' }}">{{ m }}</div>
    {% endfor %}
  {% endif %}
  {% if error %}<div class="alert alert-danger">{{ error }}</div>{% endif %}

  <div class="card">
    <div class="card-header"><i class="fas fa-filter" style="color:var(--primary)"></i><h2>Filtros</h2></div>
    <div class="card-body">
      <form method="get" class="filter-bar">
        {% if es_superusuario %}
        <div class="fg">
          <label>Institución</label>
          <select name="institucion" class="form-control" onchange="this.form.submit()">
            <option value="">— Seleccione —</option>
            {% for inst in instituciones %}
              <option value="{{ inst.pk }}" {% if institucion and inst.pk == institucion.pk %}selected{% endif %}>{{ inst.nombre }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        <div class="fg">
          <label>Curso Lectivo</label>
          <select name="curso_lectivo" class="form-control" onchange="this.form.submit()">
            {% for cl in todos_cursos %}
              <option value="{{ cl.pk }}" {% if curso_lectivo and cl.pk == curso_lectivo.pk %}selected{% endif %}>{{ cl.nombre }}</option>
            {% endfor %}
          </select>
        </div>
      </form>
    </div>
  </div>

  {% if institucion and curso_lectivo %}
  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="accion" value="guardar">
    {% if es_superusuario %}<input type="hidden" name="institucion" value="{{ institucion.pk }}">{% endif %}
    <input type="hidden" name="curso_lectivo" value="{{ curso_lectivo.pk }}">

    <div class="card">
      <div class="card-header">
        <i class="fas fa-calendar-check" style="color:var(--success)"></i>
        <h2>{{ institucion.nombre }} — {{ curso_lectivo.nombre }}</h2>
        <div style="margin-left:auto;">
          <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> Guardar</button>
        </div>
      </div>
      <div class="card-body">
        {% for item in periodo_configs %}
        <div class="periodo-card">
          <input type="checkbox" class="chk-activo" name="activos" value="{{ item.periodo.pk }}"
                 {% if item.config and item.config.activo %}checked{% endif %}>
          <div class="periodo-nombre">{{ item.periodo }}</div>
          <div class="fg">
            <label>Fecha inicio</label>
            <input type="date" class="form-control" name="fecha_inicio_{{ item.periodo.pk }}"
                   value="{% if item.config and item.config.fecha_inicio %}{{ item.config.fecha_inicio|date:'Y-m-d' }}{% endif %}">
          </div>
          <div class="fg">
            <label>Fecha fin</label>
            <input type="date" class="form-control" name="fecha_fin_{{ item.periodo.pk }}"
                   value="{% if item.config and item.config.fecha_fin %}{{ item.config.fecha_fin|date:'Y-m-d' }}{% endif %}">
          </div>
          <div style="font-size:.8rem;color:var(--muted);">
            {% if item.config and item.config.activo %}
              <span style="color:#166534;font-weight:700;">Activo</span>
            {% else %}
              <span style="color:#6c757d;">Inactivo</span>
            {% endif %}
          </div>
        </div>
        {% empty %}
        <p style="color:var(--muted);text-align:center;padding:24px;">No hay períodos en el catálogo. Cree períodos globales desde el administrador.</p>
        {% endfor %}

        {% if periodo_configs %}
        <div style="display:flex;justify-content:flex-end;margin-top:8px;">
          <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> Guardar</button>
        </div>
        {% endif %}
      </div>
    </div>
  </form>
  {% endif %}
</div>
{% endblock %}
