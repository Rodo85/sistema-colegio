{% extends "admin/base_site.html" %}
{% load static %}
{% load config_extras %}

{% block title %}Gestionar Especialidades por Curso Lectivo{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
    .gestion-container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .filtros {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
    }
    
    .filtros select {
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        margin-right: 15px;
        min-width: 200px;
    }
    
    .filtros label {
        font-weight: 600;
        margin-right: 10px;
        color: #495057;
    }
    
    .especialidades-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .especialidad-item {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 15px;
        display: flex;
        align-items: center;
        transition: all 0.2s ease;
    }
    
    .especialidad-item:hover {
        background: #e9ecef;
        border-color: #adb5bd;
    }
    
    .especialidad-item input[type="checkbox"] {
        margin-right: 15px;
        transform: scale(1.2);
    }
    
    .especialidad-info {
        flex: 1;
    }
    
    .especialidad-modalidad {
        font-weight: 600;
        color: #495057;
        margin-bottom: 5px;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .especialidad-nombre {
        font-size: 1.1em;
        color: #6c757d;
        font-weight: 500;
    }
    
    .acciones {
        text-align: center;
        margin: 20px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        margin: 0 10px;
        transition: all 0.2s ease;
    }
    
    .btn-primary {
        background: #007bff;
        color: white;
    }
    
    .btn-primary:hover {
        background: #0056b3;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-success:hover {
        background: #1e7e34;
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .btn-danger:hover {
        background: #c82333;
    }
    
    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .mensaje {
        padding: 15px;
        border-radius: 6px;
        margin: 15px 0;
        display: none;
    }
    
    .mensaje.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .mensaje.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .paginacion {
        text-align: center;
        margin-top: 20px;
    }
    
    .paginacion a {
        display: inline-block;
        padding: 8px 12px;
        margin: 0 5px;
        text-decoration: none;
        color: #007bff;
        border: 1px solid #007bff;
        border-radius: 4px;
    }
    
    .paginacion a:hover {
        background: #007bff;
        color: white;
    }
    
    .paginacion .current {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .loading {
        display: none;
        text-align: center;
        padding: 20px;
        color: #6c757d;
    }
    
    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .filtro-modalidad {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #dee2e6;
    }
    
    .filtro-modalidad select {
        min-width: 150px;
    }
</style>
{% endblock %}

{% block content %}
<div class="gestion-container">
    <h1>Gestionar Especialidades por Curso Lectivo</h1>
    
    <!-- Filtros -->
    <div class="filtros">
        <form id="filtros-form" method="get">
            {% if es_superusuario %}
            <label for="institucion">Instituci√≥n:</label>
            <select name="institucion" id="institucion" onchange="this.form.submit()">
                <option value="">Seleccionar instituci√≥n</option>
                {% for inst in instituciones %}
                <option value="{{ inst.id }}" {% if institucion.id == inst.id %}selected{% endif %}>
                    {{ inst.nombre }}
                </option>
                {% endfor %}
            </select>
            {% endif %}
            
            <label for="curso_lectivo">Curso Lectivo:</label>
            <select name="curso_lectivo" id="curso_lectivo" onchange="this.form.submit()">
                <option value="">Seleccionar curso lectivo</option>
                {% for curso in cursos_lectivos %}
                <option value="{{ curso.id }}" {% if curso_lectivo.id == curso.id %}selected{% endif %}>
                    {{ curso.nombre }}
                </option>
                {% endfor %}
            </select>
            
            <div class="filtro-modalidad">
                <label for="filtro_modalidad">Filtrar por Modalidad:</label>
                <select name="modalidad" id="filtro_modalidad" onchange="filtrarPorModalidad()">
                    <option value="">Todas las modalidades</option>
                    <option value="ACADEMICO">Acad√©mico</option>
                    <option value="TECNICO">T√©cnico</option>
                </select>
            </div>
        </form>
    </div>
    
    <!-- Mensajes -->
    <div id="mensaje" class="mensaje"></div>
    
    <!-- Loading -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Procesando cambios...</p>
    </div>
    
    {% if institucion and curso_lectivo %}
    <div class="especialidades-container">
        <h2>Especialidades para {{ institucion.nombre }} - {{ curso_lectivo.nombre }}</h2>
        
        <!-- Acciones masivas -->
        <div class="acciones">
            <button type="button" class="btn btn-success" onclick="seleccionarTodas()">
                ‚úÖ Seleccionar Todas
            </button>
            <button type="button" class="btn btn-danger" onclick="deseleccionarTodas()">
                ‚ùå Deseleccionar Todas
            </button>
            <button type="button" class="btn btn-primary" onclick="guardarCambios()">
                üíæ Guardar Cambios
            </button>
        </div>
        
        <!-- Grid de especialidades -->
        <form id="especialidades-form">
            {% csrf_token %}
            <input type="hidden" name="institucion_id" value="{{ institucion.id }}">
            <input type="hidden" name="curso_lectivo_id" value="{{ curso_lectivo.id }}">
            
                         <div class="especialidades-grid">
                 {% for especialidad in especialidades_disponibles %}
                 <div class="especialidad-item" data-modalidad="{{ especialidad.modalidad.nombre|upper }}">
                     <input type="checkbox" 
                            name="especialidades" 
                            value="{{ especialidad.id }}:true"
                            id="especialidad_{{ especialidad.id }}"
                            {% if especialidad.id in especialidades_configuradas %}
                                {% if especialidades_configuradas|get_item:especialidad.id|get_item:'activa' %}
                                    checked
                                {% endif %}
                            {% endif %}
                            onchange="actualizarValorEspecialidad({{ especialidad.id }}, this.checked)">
                     
                     <div class="especialidad-info">
                         <div class="especialidad-nombre">{{ especialidad.nombre }}</div>
                     </div>
                 </div>
                 {% empty %}
                 <p>No hay especialidades disponibles.</p>
                 {% endfor %}
             </div>
        </form>
        
        
    </div>
    {% else %}
    <div class="mensaje error">
        <p>Por favor seleccione una instituci√≥n y un curso lectivo para continuar.</p>
    </div>
    {% endif %}
</div>

<script>
function actualizarValorEspecialidad(especialidadId, activa) {
    const checkbox = document.getElementById('especialidad_' + especialidadId);
    checkbox.value = especialidadId + ':' + activa;
    
    // Guardar selecci√≥n en localStorage para persistir entre p√°ginas
    guardarSeleccion(especialidadId, activa);
}

function guardarSeleccion(especialidadId, activa) {
    const storageKey = `especialidades_seleccionadas_${getInstitucionCursoKey()}`;
    let selecciones = JSON.parse(localStorage.getItem(storageKey) || '{}');
    
    if (activa) {
        selecciones[especialidadId] = true;
    } else {
        delete selecciones[especialidadId];
    }
    
    localStorage.setItem(storageKey, JSON.stringify(selecciones));
}

function getInstitucionCursoKey() {
    const institucionId = document.querySelector('input[name="institucion_id"]').value;
    const cursoId = document.querySelector('input[name="curso_lectivo_id"]').value;
    return `${institucionId}_${cursoId}`;
}

function cargarSeleccionesGuardadas() {
    const storageKey = `especialidades_seleccionadas_${getInstitucionCursoKey()}`;
    const selecciones = JSON.parse(localStorage.getItem(storageKey) || '{}');
    
    // Solo aplicar selecciones del localStorage si no hay nada en la base de datos
    // Primero verificar si hay checkboxes ya marcados (de la base de datos)
    const checkboxesMarcados = document.querySelectorAll('input[name="especialidades"]:checked');
    
    if (checkboxesMarcados.length === 0) {
        // Si no hay nada marcado en la base de datos, aplicar localStorage
        Object.keys(selecciones).forEach(especialidadId => {
            const checkbox = document.querySelector('#especialidad_' + especialidadId);
            if (checkbox) {
                checkbox.checked = true;
                checkbox.value = especialidadId + ':true';
            }
        });
    } else {
        // Si hay checkboxes marcados de la base de datos, sincronizar localStorage
        limpiarLocalStorage();
        checkboxesMarcados.forEach(checkbox => {
            const id = checkbox.id.replace('especialidad_', '');
            guardarSeleccion(id, true);
        });
    }
}

function limpiarLocalStorage() {
    const storageKey = `especialidades_seleccionadas_${getInstitucionCursoKey()}`;
    localStorage.removeItem(storageKey);
}

function getEstados() {
    const storageKey = `especialidades_seleccionadas_${getInstitucionCursoKey()}`;
    const selecciones = JSON.parse(localStorage.getItem(storageKey) || '{}');
    
    // Convertir formato de especialidades (true/false) a formato de estados (1/0)
    const estados = {};
    Object.keys(selecciones).forEach(id => {
        estados[id] = selecciones[id] ? 1 : 0;
    });
    
    return estados;
}

function filtrarPorModalidad() {
    const modalidadSeleccionada = document.getElementById('filtro_modalidad').value;
    const especialidades = document.querySelectorAll('.especialidad-item');
    
    especialidades.forEach(item => {
        const modalidad = item.getAttribute('data-modalidad');
        if (!modalidadSeleccionada || modalidad === modalidadSeleccionada) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

function seleccionarTodas() {
    const checkboxes = document.querySelectorAll('input[name="especialidades"]:not([style*="display: none"])');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
        actualizarValorEspecialidad(checkbox.value.split(':')[0], true);
    });
}

function deseleccionarTodas() {
    const checkboxes = document.querySelectorAll('input[name="especialidades"]:not([style*="display: none"])');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        actualizarValorEspecialidad(checkbox.value.split(':')[0], false);
    });
}

function mostrarMensaje(texto, tipo) {
    const mensaje = document.getElementById('mensaje');
    mensaje.textContent = texto;
    mensaje.className = 'mensaje ' + tipo;
    mensaje.style.display = 'block';
    
    setTimeout(() => {
        mensaje.style.display = 'none';
    }, 5000);
}

function mostrarLoading(mostrar) {
    const loading = document.getElementById('loading');
    loading.style.display = mostrar ? 'block' : 'none';
}

async function guardarCambios() {
    const form = document.getElementById('especialidades-form');
    const formData = new FormData(form);
    
    // Limpiar campos previos
    formData.delete('especialidades');
    formData.delete('especialidades[]');
    
    // 1) Consolidar seleccionadas desde localStorage (todas las p√°ginas)
    const estados = getEstados();
    const idsSeleccionadosLS = Object.keys(estados).filter(id => estados[id] === 1);
    
    // 2) Asegurar tambi√©n las seleccionadas visibles por si no han sido tocadas
    const idsSeleccionadosDOM = Array.from(document.querySelectorAll('input[name="especialidades"]'))
        .filter(cb => cb.checked)
        .map(cb => cb.id.replace('especialidad_', ''));
    
    const setFinal = new Set([...idsSeleccionadosLS, ...idsSeleccionadosDOM]);
    
    // 3) Enviar en formato "id:true"
    if (setFinal.size === 0) {
        // Si nada en LS ni DOM, no enviamos nada
    } else {
        setFinal.forEach(id => formData.append('especialidades[]', `${id}:true`));
    }
    
    mostrarLoading(true);
    
    try {
        const response = await fetch('{% url "config_institucional:actualizar_especialidades_curso_lectivo" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            mostrarMensaje(data.message, 'success');
            // Recargar la p√°gina para mostrar los cambios
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            mostrarMensaje(data.message, 'error');
        }
    } catch (error) {
        mostrarMensaje('Error al guardar los cambios: ' + error.message, 'error');
    } finally {
        mostrarLoading(false);
    }
}

// Inicializar valores de los checkboxes al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Cargar selecciones guardadas del localStorage
    cargarSeleccionesGuardadas();
    
    const checkboxes = document.querySelectorAll('input[name="especialidades"]');
    checkboxes.forEach(checkbox => {
        const especialidadId = checkbox.id.replace('especialidad_', '');
        actualizarValorEspecialidad(especialidadId, checkbox.checked);
    });
    
    // Limpiar localStorage cuando se cambie de instituci√≥n o curso lectivo
    const institucionSelect = document.querySelector('#institucion');
    const cursoSelect = document.querySelector('#curso_lectivo');
    
    if (institucionSelect) {
        institucionSelect.addEventListener('change', limpiarLocalStorage);
    }
    if (cursoSelect) {
        cursoSelect.addEventListener('change', limpiarLocalStorage);
    }
});
</script>
{% endblock %}
