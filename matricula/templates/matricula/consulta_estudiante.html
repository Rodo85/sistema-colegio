{% extends 'admin/base_site.html' %}

{% block extrahead %}
  {{ block.super }}
  <style>
    /* Footer en PANTALLA (no fijo). Para PDF se redefine en @media print */
    .footer-institucional {
      text-align: center;
      font-size: 0.8em;
      margin: 16px 0 0 0;
      color: #000;
      font-weight: 600;
      width: 100%;
      position: static;      /* que NO sea fijo en pantalla */
      padding-top: 8px;      /* un poco m√°s abajo el texto */
    }

    /* Bot√≥n imprimir */
    .print-btn {
      margin-bottom: 1em;
      background: #1976d2;
      color: #fff;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .print-btn:hover {
      background: #1565c0;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(25, 118, 210, 0.4);
    }
    .print-btn:active { transform: translateY(0); }

    /* Contenedor general */
    .print-container {
      box-shadow: 0 2px 8px #bbb;
      border: 1px solid #aaa;
      border-radius: 12px;
      padding: 1.5em;
      padding-bottom: 32px;   /* espacio inferior est√°ndar; el footer ya no es fijo */
      margin: 0 auto 2em auto;
      background: #fff;
      max-width: 1000px;
    }

    /* Columnas */
    .columns { display: flex; flex-direction: column; gap: 1.5em; }
    @media (min-width: 900px) { .columns { flex-direction: row; } .col { width: 50%; } }
    .col { box-sizing: border-box; }
    .datos-personales-list { font-weight: 400 !important; }
    .datos-personales-list b { display: inline-block; min-width: 160px; font-weight: 700 !important; }
    .encargado-block { margin-bottom: 1em; font-weight: 400 !important; }
    .encargado-block b { display: inline-block; min-width: 160px; font-weight: 700 !important; }

    /* Encabezado institucional elegante */
    .header-institucional {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.8em;
      margin: 0.5em 0 0.5em 0;
      text-align: center;
    }
    .header-foto { flex: 0 0 auto; }
    .header-foto img {
      width: 140px; height: 140px; object-fit: contain;
      border-radius: 8px; border: 1px solid #999; margin-left: 2em;
      background: #f5f5f5;
    }
    .header-texto { flex: 1 1 auto; margin-left: -0.5em; }
    .titulo-matricula { font-size: 22px; font-weight: 800; letter-spacing: 2px; margin: 0.2em 0; }
    .texto-encabezado { font-size: 14px; color: #222; margin-bottom: 0.4em; font-weight: 500; line-height: 1.2em; }
    .header-logos-derecha {
      flex: 0 0 auto; display: flex; flex-direction: column; align-items: center; gap: 0.8em;
    }
    .header-logos-derecha .logo-grande { max-height: 64px; max-width: 56px; }
    .header-logos-derecha img:first-child { max-height: 80px; max-width: 200px; }

    /* Firma */
    .firma-block { text-align: left; font-size: 1em; }
    .firma-linea { border-bottom: 1.5px solid #333; width: 400px; display: inline-block; margin-bottom: 0.2em; }
    .cuerpo { margin-left: 2em; }

    /* --- ESTILOS MEJORADOS PARA LA CONSULTA (pantalla) --- */
    .consulta-container {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .consulta-title { font-size: 2.2rem; font-weight: 700; color: #2c3e50; margin-bottom: 1.5rem; text-align: center; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
    .consulta-form { display: flex; flex-wrap: wrap; gap: 1.5rem; align-items: flex-end; justify-content: center; }
    .consulta-form .btn-buscar { margin-bottom: 0; }
    .consulta-form { align-items: flex-end; }
    .consulta-form .btn-buscar[onclick*="print"] { height: auto; line-height: 1.2; padding: 0.75rem 1.5rem; margin-bottom: 0; align-self: flex-end; }
    .form-group { display: flex; flex-direction: column; min-width: 200px; }
    .form-label { font-size: 0.95rem; font-weight: 600; color: #495057; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .form-select, .form-input {
      padding: 0.75rem 1rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; background: #fff;
      transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    .form-select:focus, .form-input:focus {
      outline: none; border-color: #007bff; box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1); transform: translateY(-1px);
    }
    /* Asegurar campos de entrada funcionales */
    .form-input, .form-select {
      pointer-events: auto !important; user-select: auto !important;
      -webkit-user-select: auto !important; -moz-user-select: auto !important; -ms-user-select: auto !important; cursor: text !important;
    }
    .form-select { cursor: pointer !important; padding-right: 1rem; }
    .btn-buscar {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-size: 1rem; font-weight: 600;
      cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .btn-buscar:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4); background: linear-gradient(135deg, #218838 0%, #1ea085 100%); }
    .btn-buscar:active { transform: translateY(0); }
    .btn-limpiar {
      background: linear-gradient(135deg, #ffc107 0%, #ffcd39 100%);
      color: #212529; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-size: 1rem; font-weight: 600;
      cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .btn-limpiar:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 193, 7, 0.4); background: linear-gradient(135deg, #e0a800 0%, #f7c948 100%); }
    .btn-limpiar:active { transform: translateY(0); }
    .error-message { background: #f8d7da; color: #721c24; padding: 0.75rem 1rem; border-radius: 8px; border: 1px solid #f5c6cb; margin-top: 1rem; text-align: center; font-weight: 500; }

    /* Responsive */
    @media (max-width: 768px) {
      .consulta-container { padding: 1.5rem; }
      .consulta-form { flex-direction: column; align-items: stretch; }
      .form-group { min-width: auto; }
      .consulta-title { font-size: 1.8rem; }
    }

    /* === SOLO IMPRESI√ìN ‚Äî FIJAR P√ÅGINA Y EVITAR ESCALADO === */
    @media print {
      * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      html, body {
        background: #fff !important; color: #000 !important;
        font-family: Arial, Helvetica, sans-serif !important;
        font-size: 10.5pt !important; line-height: 1.35 !important;
        margin: 0 !important; padding: 0 !important;
      }

      /* P√°gina y m√°rgenes (Carta/Letter). Para A4: 210mm 297mm y ajuste del ancho √∫til abajo */
      @page {
        size: 216mm 279mm;
        margin: 10mm 12mm 10mm 12mm !important; /* sup, der, inf, izq */
        marks: none; bleed: 0;
      }

      /* Ocultar UI no imprimible */
      .print-btn, .noprint, .noprint *, .hide-on-print,
      .copyright, .module-footer, .breadcrumbs, .user-tools, .module-header,
      .module-title, .module-nav, .footer, .login-footer, #header, #nav-sidebar,
      #footer, #branding, .submit-row, .changeform-tabs, .object-tools,
      .object-tools li, .object-tools .addlink, .pagination, .related-widget-wrapper,
      .messagelist, .navbar, .sidebar, .admin-autocomplete, .results, .nav,
      .globalnav, .changelist-filter, .consulta-container, .consulta-form, .btn-buscar {
        display: none !important;
      }

      /* Contenedor principal: ancho √öTIL = 216 - 12 - 12 = 192 mm */
      .print-container{
        box-shadow: none !important; border: none !important; border-radius: 0 !important;
        width: 192mm !important; max-width: 192mm !important;
        padding: 0 !important; margin: 0 auto !important;
        overflow: visible !important; transform: none !important;
      }

      /* CABECERA */
      .header-institucional{
        display: grid !important;
        grid-template-columns: 38mm 1fr 32mm;
        align-items: center !important;
        column-gap: 6mm !important;
        margin: 0 0 4mm 0 !important; padding: 0 !important;
        page-break-inside: avoid !important;
      }
      .header-texto { text-align: center !important; margin: 0 !important; padding: 0 !important; }
      .header-foto img{
        width: 35mm !important; height: 35mm !important; object-fit: contain !important;
        border: 0.4pt solid #666 !important; border-radius: 2mm !important; margin: 0 !important;
        background: #f5f5f5 !important;
      }
      .titulo-matricula { font-size: 14pt !important; font-weight: 800 !important; letter-spacing: 1pt !important; margin: 0 0 2mm 0 !important; }
      .texto-encabezado { font-size: 10pt !important; line-height: 1.25 !important; margin: 0 !important; }
      .header-logos-derecha { align-items: center !important; gap: 2mm !important; }
      .header-logos-derecha img { display: block !important; margin: 0 auto !important; }
      .header-logos-derecha img:first-child { max-width: 40mm !important; max-height: 20mm !important; }
      .header-logos-derecha .logo-grande { max-width: 28mm !important; max-height: 28mm !important; }

      hr { border: 0 !important; border-top: 0.6pt solid #000 !important; margin: 3mm 0 !important; }

      /* DOS COLUMNAS ESTABLES: 93 + 93 + gap(6) = 192mm */
      .columns{
        display: grid !important;
        grid-template-columns: 93mm 93mm !important;
        gap: 6mm !important; width: 100% !important; margin: 0 !important; padding: 0 !important;
      }
      .col { break-inside: avoid !important; page-break-inside: avoid !important; }

      h2 { font-size: 12pt !important; margin: 0 0 2mm 0 !important; }

      .cuerpo { margin: 0 !important; padding: 0 !important; }
      .datos-personales-list { margin: 0 !important; padding: 0 !important; font-size: 10pt !important; }
      .datos-personales-list b { display: inline !important; min-width: 0 !important; font-weight: 700 !important; }
      .datos-personales-list br { margin-bottom: 0.8mm !important; display: block !important; }
      ul { margin: 0 0 0 4mm !important; padding: 0 !important; }
      .encargado-block { margin: 0 0 2mm 0 !important; padding: 0 !important; line-height: 1.45 !important; }
      .datos-personales-list { font-weight: 400 !important; }
      .datos-personales-list b { font-weight: 700 !important; }
      .encargado-block { font-weight: 400 !important; }
      .encargado-block b { display: inline-block; min-width: 160px; font-weight: 700 !important; }
      .encargado-block br { margin-bottom: 0.8mm !important; display: block !important; }

      .firma-linea { width: 70mm !important; border-bottom: 0.6pt solid #000 !important; display: inline-block !important; margin-bottom: 2mm !important; }

      /* PIE DE P√ÅGINA FIJO */
      .footer-institucional{
        position: fixed !important; left: 0; right: 0; bottom: 10mm;
        text-align: center !important; width: 100% !important;
        font-size: 9pt !important; margin: 0 !important; padding: 4mm 0 0 0 !important;
        page-break-inside: avoid !important;
      }

      /* Limpieza anti-escala/posici√≥n */
      .header-institucional, .columns, .col, .datos-personales-list,
      .encargado-block, .firma-block, .footer-institucional, .cuerpo {
        transform: none !important; position: static !important; float: none !important; clear: both !important;
      }

      /* Habilitar selecci√≥n si se imprime a PDF */
      .print-container * { pointer-events: auto !important; user-select: auto !important; }
    }

    /* === ESTILOS PARA PANTALLA (NO IMPRESI√ìN) === */
    .print-container, .cuerpo, .datos-personales-list, .encargado-block, .firma-block { color: #000 !important; }
    .print-container * , .cuerpo * , .datos-personales-list * , .encargado-block * , .firma-block * { color: #000 !important; }
    .print-container h2 { color: #2c3e50 !important; font-weight: 700 !important; }
    .texto-encabezado, .texto-encabezado * { color: #000 !important; }
  </style>
{% endblock %}

{% block content %}
<div class="consulta-container noprint">
  <h1 class="consulta-title">Consulta de Estudiante</h1>
  <form method="post" class="consulta-form">{% csrf_token %}
    <div class="form-group">
      <label for="id_curso_lectivo" class="form-label">Curso Lectivo</label>
      <select name="curso_lectivo" id="id_curso_lectivo" class="form-select" required>
        <option value="">Seleccione un curso lectivo</option>
        {% for curso in cursos_lectivos %}
          <option value="{{ curso.pk }}" {% if curso_lectivo and curso.pk == curso_lectivo.pk %}selected{% endif %}>{{ curso.nombre }}</option>
        {% endfor %}
      </select>
    </div>
    {% if es_superusuario %}
    <div class="form-group">
      <label for="id_institucion" class="form-label">Instituci√≥n</label>
      <select name="institucion" id="id_institucion" class="form-select" required>
        <option value="">Seleccione una instituci√≥n</option>
        {% for institucion in instituciones %}
          <option value="{{ institucion.pk }}" {% if institucion and institucion.pk == institucion.pk %}selected{% endif %}>{{ institucion.nombre }}</option>
        {% endfor %}
      </select>
    </div>
    {% endif %}
    <div class="form-group">
      <label for="id_identificacion" class="form-label">Identificaci√≥n</label>
      <input type="text" name="identificacion" id="id_identificacion"
             value="{{ identificacion }}" class="form-input" required autocomplete="off"
             placeholder="Ingrese la identificaci√≥n">
    </div>
    <div class="form-group">
      <button type="submit" name="accion" value="buscar" class="btn-buscar">üîç Buscar</button>
    </div>
    {% if identificacion %}
    <div class="form-group">
      <button type="submit" name="accion" value="limpiar" class="btn-limpiar">
        <span style="font-size:1.2em;">üßπ</span> Limpiar
      </button>
    </div>
    {% endif %}
    {% if estudiante %}
    {% if perms.matricula.print_ficha_estudiante %}
    <div class="form-group">
      <button type="button" class="btn-buscar" onclick="imprimirFichaAislada()" style="background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);">
        <span style="font-size:1.2em;">üñ®Ô∏è</span> Imprimir ficha
      </button>
    </div>
    {% endif %}
    {% if perms.matricula.print_comprobante_matricula %}
    <div class="form-group">
      <button type="button" class="btn-buscar" onclick="imprimirComprobanteMatricula()" style="background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);">
        <span style="font-size:1.2em;">üßæ</span> Imprimir comprobante
      </button>
    </div>
    {% endif %}
    {% endif %}
  </form>
  {% if error %}<div class="error-message">{{ error }}</div>{% endif %}
</div>

{% if estudiante %}
  <div id="ficha-impresion" class="print-container">
    <!-- Encabezado institucional -->
    <div class="header-institucional">
      <div class="header-foto">
        {% if estudiante.foto %}
          <img src="{{ estudiante.foto.url }}" alt="Foto estudiante">
        {% else %}
          <div style="width:180px;height:180px;background:#eee;border-radius:8px;border:1px solid #aaa;display:flex;align-items:center;justify-content:center;color:#999;font-size:.9em;">
            Sin&nbsp;foto
          </div>
        {% endif %}
      </div>
      <div class="header-texto">
        <div class="titulo-matricula">{{ plantilla.titulo|default:"CURSO LECTIVO 2025"|cut:"MATR√çCULA " }}</div>
        <div class="texto-encabezado">{{ plantilla.encabezado|safe|linebreaksbr }}</div>
      </div>
      <div class="header-logos-derecha">
        {% if plantilla and plantilla.logo_mep %}<img src="{{ plantilla.logo_mep.url }}" alt="Logo MEP" class="logo-grande">{% endif %}
        {% if institucion and institucion.logo %}<img src="{{ institucion.logo.url }}" alt="Logo instituci√≥n" class="logo-grande">{% endif %}
      </div>
    </div>

    <hr>

    <div class="columns cuerpo">
      <!-- Columna izquierda -->
      <div class="col">
        <h2>Datos del Estudiante</h2>
        <div style="display:flex;gap:1em;align-items:flex-start;">
          <div class="datos-personales-list">
            <strong style="font-size: 1.4em; color: #2c3e50;">{{ estudiante.primer_apellido|default:"---" }} {{ estudiante.segundo_apellido|default:"---" }} {{ estudiante.nombres|default:"---" }}</strong><br>
            <strong style="font-size: 20px; color: #2c3e50;">{{ estudiante.identificacion|default:"---" }}</strong><br>
            <b>Tipo identificaci√≥n:</b> {{ estudiante.tipo_identificacion|default:"---" }}<br>
            <b>Tipo estudiante:</b> {{ estudiante.get_tipo_estudiante_display|default:"---" }}<br>
            <b>Nivel:</b> {{ matricula.nivel|default:"---" }}<br>
            {% if matricula.especialidad %}
              {% if matricula.nivel.nombre == 'D√©cimo' or matricula.nivel.nombre == 'Und√©cimo' or matricula.nivel.nombre == 'Duod√©cimo' %}
                <b>Especialidad:</b> {{ matricula.especialidad }}<br>
              {% endif %}
            {% endif %}
            <b>Fecha nacimiento:</b> {{ estudiante.fecha_nacimiento|default:"---" }}<br>
            <b>Edad:</b> {{ edad_estudiante|default:"---" }}<br>
            <b>G√©nero:</b> {{ estudiante.sexo|default:"---" }}<br>
            <b>Nacionalidad:</b> {{ estudiante.nacionalidad|default:"---" }}<br>
            <b>Celular:</b> {{ estudiante.celular|default:"---" }}<br>
            <b>Tel√©fono casa:</b> {{ estudiante.telefono_casa|default:"---" }}<br>
            <b>Correo:</b> {{ estudiante.correo|default:"---" }}<br>
            <b>Domicilio:</b> {{ estudiante.provincia|default:"---" }}, {{ estudiante.canton|default:"---" }}, {{ estudiante.distrito|default:"---" }}<br>
            <b>Direcci√≥n exacta:</b> {{ estudiante.direccion_exacta|default:"---" }}<br>
            <b>Recibe Ed. Religiosa:</b> {{ estudiante.ed_religiosa|yesno:"S√≠,No" }}<br>
            <b>Adecuaci√≥n:</b> {{ estudiante.adecuacion|default:"---" }}<br>
            <b>Presenta enfermedad:</b> {{ estudiante.presenta_enfermedad|yesno:"S√≠,No,---" }}<br>
            <b>Detalle enfermedad:</b> {{ estudiante.detalle_enfermedad|default:"---" }}<br>
            <b>Medicamentos que consume:</b> {{ estudiante.medicamento_consume|default:"Ninguno" }}<br>

            {% if estudiante.tipo_estudiante == 'PN' %}
            <br>
            <b>Posee carnet de CONAPDIS:</b> {{ estudiante.posee_carnet_conapdis|yesno:"S√≠,No" }}<br>
            <b>Posee v√°lvula de drenaje LCR:</b> {{ estudiante.posee_valvula_drenaje_lcr|yesno:"S√≠,No" }}<br>
            <b>Usa alg√∫n tipo de apoyo:</b> {{ estudiante.usa_apoyo|yesno:"S√≠,No" }}<br>
            {% if estudiante.usa_apoyo %}<b>¬øCu√°l apoyo?</b> {{ estudiante.apoyo_cual|default:"---" }}<br>{% endif %}
            <b>Tipo de condici√≥n diagnosticada:</b> {% if estudiante.tipo_condicion_diagnosticada %}{{ estudiante.get_tipo_condicion_diagnosticada_display }}{% else %} --- {% endif %}<br>
            {% if estudiante.tipo_condicion_diagnosticada == 'OT' %}<b>Otro (especifique condici√≥n):</b> {{ estudiante.tipo_condicion_otro|default:"---" }}<br>{% endif %}
            <b>Posee alg√∫n tipo de control:</b> {{ estudiante.posee_control|yesno:"S√≠,No" }}<br>
            {% if estudiante.posee_control %}<b>¬øCu√°l control?</b> {{ estudiante.control_cual|default:"---" }}<br>{% endif %}
            <b>Existe persona con orden de alejamiento:</b> {{ estudiante.orden_alejamiento|yesno:"S√≠,No,---" }}<br>
            {% if estudiante.orden_alejamiento %}<b>Nombre de la persona con orden:</b> {{ estudiante.orden_alejamiento_nombre|default:"---" }}<br>{% endif %}
            {% endif %}

            <b>Autoriza derecho de imagen:</b> {{ estudiante.autoriza_derecho_imagen|yesno:"S√≠,No" }}<br>
            <b>N√∫mero de p√≥liza:</b> {{ estudiante.numero_poliza|default:"---" }}<br>
            <b>Rige p√≥liza:</b> {{ estudiante.rige_poliza|default:"---" }}<br>
            <b>Vence p√≥liza:</b> {{ estudiante.vence_poliza|default:"---" }}<br>
          </div>
        </div>
      </div>

      <!-- Columna derecha -->
      <div class="col">
        <h2>Encargados</h2>
        {% if encargados %}
          <ul>
            {% for enc in encargados %}
              <li class="encargado-block">
                <b>{{ enc.persona_contacto }}</b> ({{ enc.parentesco }})<br>
                <b>Identificaci√≥n:</b> {{ enc.persona_contacto.identificacion|default:"---" }}<br>
                <b>Celular:</b> {{ enc.persona_contacto.celular_avisos|default:"---" }}<br>
                <b>Correo:</b> {{ enc.persona_contacto.correo|default:"---" }}<br>
                <b>Lugar de trabajo:</b> {{ enc.persona_contacto.lugar_trabajo|default:"---" }}<br>
                <b>Tel√©fono trabajo:</b> {{ enc.persona_contacto.telefono_trabajo|default:"---" }}<br>
                <b>Estado civil:</b> {{ enc.persona_contacto.estado_civil|default:"---" }}<br>
                <b>Escolaridad:</b> {{ enc.persona_contacto.escolaridad|default:"---" }}<br>
                <b>Ocupaci√≥n:</b> {{ enc.persona_contacto.ocupacion|default:"---" }}<br>
                <b>Convive con el estudiante:</b> {{ enc.convivencia|yesno:"S√≠,No" }}<br>
                <b>Encargado principal:</b> {{ enc.principal|yesno:"S√≠,No" }}<br>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p>No hay encargados registrados.</p>
        {% endif %}

        <div class="firma-block">
          <br>
          <b>Fecha asignaci√≥n:</b> {{ matricula.fecha_asignacion|default:"---" }}<br><br><br>
          <span>Firma responsable:</span><br><br>
          <span class="firma-linea"></span><br>
          <span>C√©dula:</span><br><br>
          <span class="firma-linea"></span><br><br><br><br>
        </div>
      </div>
    </div>

    {% if plantilla and plantilla.pie_pagina %}
      <div class="footer-institucional">
        {{ plantilla.pie_pagina|safe|linebreaksbr }}
      </div>
    {% endif %}
  </div>
{% endif %}

<script>
function imprimirFichaAislada() {
  const nodo = document.getElementById('ficha-impresion');
  if (!nodo) return alert('No se encontr√≥ el contenido a imprimir.');

  const html = nodo.outerHTML;

  /* CSS m√≠nimo y aislado para el iframe de impresi√≥n.
     Carta/Letter: 216x279 mm, m√°rgenes 12/10. Si usa A4, cambie dimensiones
     y ancho √∫til (ver comentario inicial). */
  const css = `
    @page {
      size: 216mm 279mm;
      margin: 10mm 12mm 10mm 12mm;
      marks: none; bleed: 0;
    }
    html, body {
      background: #fff; color: #000; font-family: Arial, sans-serif; font-size: 10.5pt; line-height: 1.35;
      margin: 0; padding: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact;
    }
    * { box-sizing: border-box; }

    .print-container{
      box-shadow: none !important; border: none !important; border-radius: 0 !important;
      width: 192mm !important; max-width: 192mm !important; margin: 0 auto !important; padding: 0 !important;
      overflow: visible !important; transform: none !important;
    }

    .header-institucional{
      display: grid !important; grid-template-columns: 38mm 1fr 32mm; align-items: center;
      column-gap: 6mm; margin: 0 0 4mm 0; padding: 0; width: 100%; page-break-inside: avoid;
    }
    .header-texto { text-align: center !important; margin: 0 !important; padding: 0 !important; }
    .header-foto img { width: 35mm; height: 35mm; object-fit: contain; border: 0.4pt solid #666; border-radius: 2mm; margin: 0; background: #f5f5f5; }
    .titulo-matricula { font-size: 14pt; font-weight: 800; letter-spacing: 1pt; margin: 0 0 2mm 0; }
    .texto-encabezado { font-size: 10pt; line-height: 1.25; margin: 0; }
    .header-logos-derecha { display: flex; flex-direction: column; align-items: center; gap: 2mm; }
    .header-logos-derecha img { display: block; margin: 0 auto; }
    .header-logos-derecha img:first-child { max-width: 40mm; max-height: 20mm; }
    .header-logos-derecha .logo-grande { max-width: 28mm; max-height: 28mm; }

    hr { border: 0; border-top: 0.6pt solid #000; margin: 3mm 0; }

    .columns{
      display: grid !important; grid-template-columns: 93mm 93mm !important; gap: 6mm;
      width: 100%; margin: 0; padding: 0;
    }
    .col { break-inside: avoid; page-break-inside: avoid; }

    h2 { font-size: 12pt; margin: 0 0 2mm 0; }
    .cuerpo { margin: 0; padding: 0; }

    .datos-personales-list strong { display: block !important; margin-bottom: 1mm !important; font-size: 12pt !important; }
    .datos-personales-list { margin: 0; padding: 0; font-size: 10pt; line-height: 1.5 !important; }
    .datos-personales-list b { display: inline; min-width: 0; font-weight: 700; }
    .datos-personales-list br { margin-bottom: 0.8mm !important; display: block !important; }

    ul { margin: 0 0 0 4mm; padding: 0; }
    .encargado-block { margin: 0 0 2mm 0; padding: 0; line-height: 1.45 !important; }
    .encargado-block br { margin-bottom: 0.8mm !important; display: block !important; }

    .firma-linea { width: 70mm; border-bottom: 0.6pt solid #000; display: inline-block; margin-bottom: 2mm; }

    .footer-institucional {
      position: fixed; left: 0; right: 0; bottom: 10mm; text-align: center; width: 100%;
      font-size: 9pt; margin: 0; padding: 4mm 0 0 0; page-break-inside: avoid;
    }
  `;

  // Imprimir en un iframe oculto (sin abrir nuevas ventanas)
  const iframe = document.createElement('iframe');
  iframe.style.position = 'fixed';
  iframe.style.right = '-10000px';
  iframe.style.bottom = '0';
  iframe.style.width = '0';
  iframe.style.height = '0';
  iframe.style.opacity = '0';
  iframe.setAttribute('aria-hidden', 'true');
  document.body.appendChild(iframe);

  const doc = iframe.contentWindow.document;
  doc.open();
  doc.write(`<!doctype html><html><head><meta charset="utf-8"><title>Ficha del estudiante</title><style>${css}</style></head><body>${html}</body></html>`);
  doc.close();

  iframe.onload = function() {
    const iw = iframe.contentWindow;
    const waitForImages = () => {
      const imgs = iw.document.images;
      for (let i = 0; i < imgs.length; i++) {
        if (!imgs[i].complete) { setTimeout(waitForImages, 60); return; }
      }
      iw.focus();
      iw.print();
      iw.onafterprint = () => { try { document.body.removeChild(iframe); } catch (e) {} };
      setTimeout(() => { try { document.body.removeChild(iframe); } catch (e) {} }, 1200);
    };
    waitForImages();
  };
}

function imprimirComprobanteMatricula() {
  const cursoInput = document.getElementById('id_curso_lectivo');
  const cursoId = cursoInput ? cursoInput.value : '';
  const identificacion = document.getElementById('id_identificacion')?.value || '';
  if (!cursoId || !identificacion) {
    alert('Faltan datos para imprimir el comprobante.');
    return;
  }
  let url = '{% url "matricula:comprobante_matricula" %}?curso_lectivo_id=' + encodeURIComponent(cursoId) + '&identificacion=' + encodeURIComponent(identificacion);
  const instSel = document.getElementById('id_institucion');
  if (instSel && instSel.value) {
    url += '&institucion_id=' + encodeURIComponent(instSel.value);
  }
  
  // Usar la misma t√©cnica que imprimir ficha
  fetch(url)
    .then(response => response.text())
    .then(html => {
      // Crear iframe oculto para imprimir
      const iframe = document.createElement('iframe');
      iframe.style.position = 'fixed';
      iframe.style.right = '-10000px';
      iframe.style.bottom = '0';
      iframe.style.width = '0';
      iframe.style.height = '0';
      iframe.style.opacity = '0';
      iframe.setAttribute('aria-hidden', 'true');
      document.body.appendChild(iframe);
      
      const doc = iframe.contentWindow.document;
      doc.open();
      doc.write(html);
      doc.close();
      
      iframe.onload = function() {
        const iw = iframe.contentWindow;
        const waitForImages = () => {
          const imgs = iw.document.images;
          for (let i = 0; i < imgs.length; i++) {
            if (!imgs[i].complete) { 
              setTimeout(waitForImages, 60); 
              return; 
            }
          }
          iw.focus();
          iw.print();
          iw.onafterprint = () => { 
            try { document.body.removeChild(iframe); } catch (e) {} 
          };
          setTimeout(() => { 
            try { document.body.removeChild(iframe); } catch (e) {} 
          }, 1200);
        };
        waitForImages();
      };
    })
    .catch(err => {
      alert('Error al cargar el comprobante: ' + err.message);
    });
}

// (Se elimin√≥ l√≥gica de asignaci√≥n de grupo en esta pantalla)
</script>

{% endblock %}
